(function(f){var m=f.event,k=["dropover","dropon","dropout","dropinit","dropmove","dropend"];f.Drop=function(a,b){jQuery.extend(this,a);this.element=f(b)};f.each(k,function(){m.special[this]={add:function(){var a=f(this),b=a.data("dropEventCount")||0;a.data("dropEventCount",b+1);b==0&&f.Drop.addElement(this)},remove:function(){var a=f(this),b=a.data("dropEventCount")||0;a.data("dropEventCount",b-1);b<=1&&f.Drop.removeElement(this)}}});f.extend(f.Drop,{lowerName:"drop",_rootElements:[],_elements:f(),
last_active:[],endName:"dropon",addElement:function(a){for(var b=0;b<this._rootElements.length;b++)if(a==this._rootElements[b])return;this._rootElements.push(a)},removeElement:function(a){for(var b=0;b<this._rootElements.length;b++)if(a==this._rootElements[b]){this._rootElements.splice(b,1);return}},sortByDeepestChild:function(a,b){a=a.element.compare(b.element);if(a&16||a&4)return 1;if(a&8||a&2)return-1;return 0},isAffected:function(a,b,c){return c.element!=b.element&&c.element.within(a[0],a[1],
c._cache).length==1},deactivate:function(a,b,c){b.out(c,a);a.callHandlers(this.lowerName+"out",a.element[0],c,b)},activate:function(a,b,c){b.over(c,a);a.callHandlers(this.lowerName+"over",a.element[0],c,b)},move:function(a,b,c){a.callHandlers(this.lowerName+"move",a.element[0],c,b)},compile:function(a,b){if(this.dragging||b){if(!this.dragging){this.dragging=b;this.last_active=[]}for(var c,e,d,g=[],i=this.dragging,h=0;h<this._rootElements.length;h++){b=this._rootElements[h];c=f.event.findBySelector(b,
k);for(e in c){d=e?jQuery(e,b):[b];for(var j=0;j<d.length;j++)this.addCallbacks(d[j],c[e],i)&&g.push(d[j])}}this.add(g,a,i)}},addCallbacks:function(a,b,c){var e=f.data(a,"_dropData");if(e){if(!c){for(var d in b)e[d]=e[d]?e[d].concat(b[d]):b[d];return false}}else{f.data(a,"_dropData",new f.Drop(b,a));return true}},add:function(a,b,c){for(var e=0,d;e<a.length;){d=f.data(a[e],"_dropData");d.callHandlers(this.lowerName+"init",a[e],b,c);if(d._canceled)a.splice(e,1);else e++}this._elements.push.apply(this._elements,
a)},show:function(a,b,c){if(this._elements.length){var e=[],d=true,g=0,i,h,j,l=this.last_active;for(i=this;g<this._elements.length;)if(h=f.data(this._elements[g],"_dropData")){g++;i.isAffected(a,b,h)&&e.push(h)}else this._elements.splice(g,1);e.sort(this.sortByDeepestChild);c.stopRespondPropagate=function(){d=false};h=e.slice();this.last_active=e;for(a=0;a<l.length;a++){i=l[a];for(g=0;j=h[g];)if(i==j){h.splice(g,1);break}else g++;j||this.deactivate(i,b,c);if(!d)return}for(g=0;g<h.length;g++){this.activate(h[g],
b,c);if(!d)return}for(g=0;g<e.length;g++){this.move(e[g],b,c);if(!d)return}}},end:function(a,b){for(var c,e=this.lowerName+"end",d=0;d<this.last_active.length;d++){c=this.last_active[d];this.isAffected(a.vector(),b,c)&&c[this.endName]&&c.callHandlers(this.endName,null,a,b)}for(d=0;d<this._elements.length;d++)(c=f.data(this._elements[d],"_dropData"))&&c.callHandlers(e,null,a,b);this.clear()},clear:function(){this._elements.each(function(){f.removeData(this,"_dropData")});this._elements=f();delete this.dragging}});
f.Drag.responder=f.Drop;f.extend(f.Drop.prototype,{callHandlers:function(a,b,c,e){for(var d=this[a]?this[a].length:0,g=0;g<d;g++)this[a][g].call(b||this.element[0],c,this,e)},cache:function(a){this._cache=a!=null?a:true},cancel:function(){this._canceled=true}})})(jQuery);
